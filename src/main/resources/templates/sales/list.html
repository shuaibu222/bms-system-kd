<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en-US" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Sales Page</title>
    <script defer>
        let cart = [];
        let totalAmount = 0;

        function addToCart(id, name, price, store) {
            const existingItem = cart.find(item => item.id === id && item.store === store);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ id, name, price, quantity: 1, store });
            }
            updateCart();
        }


        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            updateCart();
        }

        function clearCart() {
            cart = [];
            updateCart();
        }

        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            totalAmount = 0;

            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <span>${item.name} (${item.store}) x ${item.quantity}</span>
                    <span>₦${Number((item.price * item.quantity).toFixed(2)).toLocaleString()}</span>
                    <button onclick="removeFromCart(${item.id})">Remove</button>
                `;
                cartItems.appendChild(cartItem);
                totalAmount += item.price * item.quantity;
            });

            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('clearCartBtn').disabled = cart.length === 0;
            document.getElementById('checkoutBtn').disabled = cart.length === 0;
        }

        function filterProducts() {
            let searchValue = document.getElementById("searchInput").value.toLowerCase();
            let products = document.querySelectorAll(".product-item");

            products.forEach(product => {
                let productName = product.textContent.toLowerCase();
                product.style.display = productName.includes(searchValue) ? "flex" : "none";
            });

            // Ensure cart actions remain functional after filtering
            updateCart();
        }
        async function checkout() {
            const customerName = document.getElementById("customerSelect").value;
            const saleDate = document.getElementById("saleDate").value;

            if (!customerName) {
                alert("Please select a customer.");
                return;
            }

            if (!saleDate) {
                alert("Please select a sale date.");
                return;
            }

            if (cart.length === 0) {
                alert("Cart is empty.");
                return;
            }

            const orderData = {
                customerName: customerName,
                saleDateTime: saleDate,
                totalAmount: totalAmount,
                items: cart.map(item => ({
                    productName: item.name,
                    store: item.store, // Include store name
                    quantity: item.quantity,
                    price: item.price
                }))
            };

            try {
                const response = await fetch('/sales/checkout', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    window.location.href = "/sales/success";
                } else {
                    const errorMessage = await response.text();
                    alert("Checkout failed: " + errorMessage);
                }
            } catch (error) {
                console.error("Error during checkout:", error);
                alert("An error occurred.");
            }
        }

    </script>
</head>
<body>
    <section layout:fragment="body">
        <div class="pos-container">
            <div class="product-list">
                <h2>Products</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search products..." onkeyup="filterProducts()">
                </div>
                <div id="productList">
                    <div th:each="product : ${products}" class="product-item">
                        <span th:text="${product.name} + ' (' + ${product.store} + ') - ₦' + ${#numbers.formatDecimal(product.price, 0, 'COMMA', 2, 'POINT')}"></span>
                        <span th:class="${product.quantity > 0} ? 'stock-in' : 'stock-out'" th:text="${product.quantity > 0} ? 'stock-in' : 'stock-out'"></span>
                        <button th:attr="onclick='addToCart(' + ${product.id} + ', \'' + ${product.name} + '\', ' + ${product.price} + ', \'' + ${product.store} + '\')'">Add</button>
                    </div>
                </div>                
            </div>            

            <div class="cart">
                <h2>Cart</h2>
                
                <!-- New Customer & Date Section -->
                <div class="customer-details">
                    <label for="customerSelect">Customer Name:</label>
                    <select id="customerSelect">
                        <option value="">-- Select Customer --</option>
                        <option th:each="customer : ${customers}" 
                                th:value="${customer.name}" 
                                th:text="${customer.name}">
                        </option>
                    </select>

                    <label for="saleDate">Date:</label>
                    <input type="date" id="saleDate">
                </div>

                <div class="cart-items" id="cartItems"></div>
                <div class="cart-total">
                    Total: ₦<span id="totalAmount">0.00</span>
                </div>
                <div class="cart-actions">
                    <button onclick="clearCart()" disabled id="clearCartBtn">Clear Cart</button>
                    <button onclick="checkout()" disabled id="checkoutBtn">Checkout</button>
                </div>
            </div>
        </div>
    </section>
</body>
</html>
